# åœ¨ Visual Studio ä¸­æ„å»º .NET nanoFramework

âš ï¸ å…³äºæ„å»º .NET nanoFramework å›ºä»¶çš„è¯´æ˜ âš ï¸

åªæœ‰åœ¨è®¡åˆ’è°ƒè¯•æœ¬æœºä»£ç ã€æ·»åŠ æ–°ç›®æ ‡æˆ–åœ¨æœ¬æœºçº§åˆ«æ·»åŠ æ–°åŠŸèƒ½æ—¶æ‰éœ€è¦æ„å»ºå®ƒã€‚
å¦‚æœæ‚¨çš„ç›®æ ‡æ˜¯ä½¿ç”¨ C# è¿›è¡Œç¼–ç ï¼Œåªéœ€ä½¿ç”¨é€‚å½“çš„å›ºä»¶æ˜ åƒåˆ·å†™æ‚¨çš„ MCUã€‚
æœ‰å¤šä¸ªç›®æ ‡å¯ç”¨çš„å›ºä»¶æ˜ åƒå¯ä¾›åˆ·å†™ï¼Œè¯·æŸ¥çœ‹[Home](https://github.com/nanoframework/Home#firmware-for-reference-boards)å­˜å‚¨åº“ã€‚

## ä½¿ç”¨ Visual Studio 2019 Community ç‰ˆæœ¬å¼€å‘ nanoFramework å›ºä»¶

ï¼ˆæœ‰å…³ VS2017ï¼Œè¯·å‚é˜…ä¸‹æ–‡ï¼‰

ä¸‹é¢æè¿°çš„å¼€å‘è¿‡ç¨‹æœ€åˆæ˜¯é’ˆå¯¹ STM32/ChibiOS ç›®æ ‡è¿›è¡Œçš„ï¼Œç¨åæ·»åŠ äº† Espressif ESP32ã€‚åœ¨æœ¬æ›´æ–°ä¸­ï¼Œæˆ‘ä»¬å°†ä»¥ ESP32 ä½œä¸ºç¤ºä¾‹ï¼Œæœ‰å…³ STM32 çš„ç‰¹å®šä¿¡æ¯è¯·å‚é˜… VS2017 éƒ¨åˆ†ã€‚

> åœ¨ ChibiOS æ„å»ºä¸­ä½¿ç”¨çš„éå¸¸é•¿çš„æ–‡ä»¶åå¯èƒ½ä¼šè¶…å‡º Windows 250 ä¸ªå­—ç¬¦çš„è·¯å¾„é™åˆ¶ã€‚æœ‰æ—¶ï¼ŒCMake ä¼šå¯¹æ­¤å‘å‡ºè­¦å‘Šï¼Œæˆ–è€…æ‚¨å¯èƒ½ä¼šé‡åˆ°ä¼¼ä¹éšæœºå¤±è´¥çš„æ„å»ºã€‚æ­¤å‰è§£å†³æ­¤é—®é¢˜çš„æ–¹æ³•æ˜¯å°†æºä»£ç æ”¾ç½®åœ¨é¡¶çº§ç›®å½•ä¸­ã€‚ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨ Windows çš„ `SUBST` å‘½ä»¤é€šè¿‡æ˜ å°„çš„è·¯å¾„è®¿é—®æºä»£ç ã€‚æä¾›äº†ä¸€äº›è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹çš„å·¥å…·ã€‚

### é¦–å…ˆä½¿ç”¨ VS Code è®¾ç½®å·¥ä½œæ„å»ºç¯å¢ƒï¼ˆæ¨èï¼‰

è™½ç„¶å¯ä»¥ä½¿ç”¨ VS 2019 è®¾ç½®æˆåŠŸçš„æ„å»ºå’Œè°ƒè¯•ç¯å¢ƒï¼Œä½†å¼ºçƒˆå»ºè®®é¦–å…ˆè®¾ç½® VS Code ç¯å¢ƒã€‚è¿™æ˜¯æœ€å¸¸ç”¨å’Œç»è¿‡æµ‹è¯•çš„è·¯å¾„ï¼Œå¦‚æœæ‚¨åœ¨é€”ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œå¾ˆå¯èƒ½èƒ½å¤Ÿå¾—åˆ°å…¶ä»–ç”¨æˆ·çš„å¸®åŠ©ã€‚ä¸€æ—¦è®¾ç½®å®Œæ¯•ï¼Œæ‚¨å¯ä»¥åˆ‡æ¢åˆ°æ‚¨é¦–é€‰çš„ IDEï¼

è¯·å‚è€ƒä»¥ä¸‹å…¶ä¸­ä¸€ç¯‡æŒ‡å—ï¼š

- [ä½¿ç”¨ VS Code å’Œ ESP32 å…¥é—¨](build-esp32.md)

- [ä½¿ç”¨ VS Code å’Œ STM32 å…¥é—¨](build-stm32.md)

### å®‰è£… Visual Studio 2019 Community å’Œç›¸å…³å·¥ä½œè´Ÿè½½

æ‚¨ç°åœ¨åº”è¯¥å·²ç»å‡†å¤‡å¥½æ„å»ºã€éƒ¨ç½²å’Œè°ƒè¯• nanoFramework è§£é‡Šå™¨æ‰€éœ€çš„ç»„ä»¶ï¼Œæ‚¨å¯èƒ½å·²ç»å®‰è£…äº† Visual Studio å¹¶å°è¯•è¿è¡Œäº†ä¸€äº›æ‰˜ç®¡ä»£ç ç¤ºä¾‹ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦å°†è¿™äº›ç»„ä»¶ä¸ Visual Studio é›†æˆï¼Œä»¥ä¾¿åœ¨å…¶ä¸­ä½¿ç”¨å®ƒæ¥è¿è¡Œæ„å»º/éƒ¨ç½²/è°ƒè¯•è¿‡ç¨‹ã€‚

å®‰è£…ä»¥ä¸‹ç»„ä»¶ï¼š

| è½¯ä»¶ | å·¥ä½œè´Ÿè½½/ç»„ä»¶ |
|:---|---|
| Visual Studio 2019 Community ç‰ˆæœ¬ | Linux C++ å¼€å‘ |
|option|é€‚ç”¨äº Windows å’Œ Linux çš„ C++ CMake å·¥å…· |
|option|åµŒå…¥å¼å’Œç‰©è”ç½‘å¼€å‘å·¥å…· |

### é…ç½®æ–‡ä»¶



VS Code å’Œ VS2019/2017 å°†å¤§å¤šæ•°é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨åä¸º `"hidden"` çš„ç›®å½•ä¸­ï¼ˆåœ¨ Unix/Linux ä¸­ï¼Œä»¥ç‚¹å¼€å¤´çš„ç›®å½•åè¢«è§†ä¸ºéšè—ï¼‰ã€‚å¯¹äº VS Codeï¼Œè¯¥ç›®å½•åä¸º `".vscode"`ï¼Œå¯¹äº VS2019ï¼Œè¯¥ç›®å½•åä¸º `".vs"`ï¼Œè¿™æœ‰åŠ©äºé¿å…å®ƒä»¬äº’ç›¸å†²çªã€‚
VS2019 IDE é€šå¸¸ä¼šåœ¨ `Solution Explorer` ä¸­éšè—æ­¤ç›®å½•çš„å†…å®¹ï¼Œä½†æ˜¯å¦‚æœæ‚¨åœ¨ `Solution Explorer` çª—æ ¼é¡¶éƒ¨çš„ä»»åŠ¡æ ä¸Šæ‚¬åœåœ¨å›¾æ ‡ä¸Šï¼Œæ‚¨å°†æ‰¾åˆ° `"æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶"` é€‰é¡¹ã€‚é€‰æ‹©è¯¥é€‰é¡¹åï¼Œè¿™äº›æ–‡ä»¶å°†åœ¨ `"æœ¬åœ°è®¾ç½® (.vs)"` ä¸‹æ–¹æ˜¾ç¤ºã€‚

`.vs` ä¸­çš„ä¸¤ä¸ªé…ç½®æ–‡ä»¶æ˜¯ `tasks.vs.json` å’Œ `launch.vs.json`ã€‚å½“æ‚¨å…‹éš† `nf-interpreter` å­˜å‚¨åº“æ—¶ï¼Œå°†æœ‰ä¸¤ä¸ªæ–‡ä»¶åä¸º `tasks.vs.SAMPLE.json` å’Œ `launch.vs.SAMPLE.json`ï¼Œæ‚¨å¯ä»¥å°†å…¶å¤åˆ¶ä¸ºé€‚å½“çš„åç§°ï¼Œç„¶åæ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›æ˜¯ `SAMPLE` æ–‡ä»¶è€Œä¸æ˜¯ `TEMPLATE` æ–‡ä»¶ï¼Œå› ä¸ºå®ƒä»¬ä¸ç”¨ä½œè‡ªåŠ¨é…ç½®çš„åŸºç¡€ï¼Œè€Œæ˜¯ä½œä¸ºå·²çŸ¥å¯å·¥ä½œç¤ºä¾‹çš„å­˜åœ¨ã€‚

>ä¸ VS2017 ä¸åŒï¼ŒVS2019 ç›®å‰ä¼šé‡å†™æ‚¨çš„ JSON é…ç½®æ–‡ä»¶ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­åˆ é™¤æ‚¨æ·»åŠ çš„ä»»ä½•æ³¨é‡Šã€‚è¿™å¯èƒ½ä¸¥æ ¼éµå¾ª JSON è§„èŒƒï¼Œä½†å¯¹äºäººç±»å¯è¯»çš„é…ç½®æ–‡ä»¶æ¥è¯´æ˜¯ä¸€ä¸ªéå¸¸ç³Ÿç³•çš„äº‹æƒ…ï¼å¸Œæœ›å¾®è½¯èƒ½å¤Ÿæ„è¯†åˆ°è¿™ä¸€ç‚¹å¹¶æ”¹å˜è¿™ç§è¡Œä¸ºï¼Œæˆ–è€…é‡‡ç”¨æ›´åŠ åˆç†çš„æ ¼å¼ï¼Œæ¯”å¦‚ [JSON5](https://json5.org/)

#### tasks.vs.json

æ­¤æ–‡ä»¶å°†ä¸º `Solution Explorer` çª—æ ¼ä¸­çš„é¡¹ç›®æä¾›ä¸€äº›å³é”®å•å‡»ä¸Šä¸‹æ–‡èœå•é¡¹ï¼Œä¾‹å¦‚ `CMakeLists.txt`ã€‚ç¤ºä¾‹æ–‡ä»¶é’ˆå¯¹ ESP32 è¿›è¡Œäº†è®¾ç½®ï¼Œå¹¶ä½¿ç”¨ `esptool.py` æ¥æ“¦é™¤æˆ–ç¼–ç¨‹è®¾å¤‡ä¸Šçš„ Flashã€‚æ‚¨å¯èƒ½éœ€è¦åœ¨æ–‡ä»¶é¡¶éƒ¨é™„è¿‘ä¿®æ”¹ `"port"` è®¾ç½®ï¼Œå°†å…¶ä» `COM3` ä¿®æ”¹ä¸ºæ‚¨ ESP32 è¿æ¥çš„ç«¯å£ã€‚

#### launch.vs.json

æ­¤æ–‡ä»¶ç”¨äºå¯åŠ¨è°ƒè¯•å™¨ï¼Œä½¿ç”¨æœ¬åœ°çš„ `GDB` å’Œ `OpenOCD` ä½œä¸º GDB æœåŠ¡å™¨ï¼Œæä¾›ä¸è®¾å¤‡çš„è¿æ¥ã€‚ç¤ºä¾‹ä¸­çš„ ESP32 éƒ¨åˆ†ä½¿ç”¨ `SEGGER JLINK` è®¾å¤‡è¿æ¥åˆ° ESP32 çš„ JTAG å¼•è„šï¼Œè€Œ STM32 ç¤ºä¾‹ä½¿ç”¨ STM769IDiscovery æ¿ä¸Šçš„ `STM32 STLINK` æ¥å£ã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å°šæœªèƒ½å¤Ÿå®Œå…¨ä½¿ç”¨ VS2019 èµ„æºä½¿è°ƒè¯•ç³»ç»Ÿæ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªåä¸º `"startocd.bat"` çš„ Windows æ‰¹å¤„ç†æ–‡ä»¶æ¥å¤„ç† `OpenOCD` çš„é…ç½®ç»†èŠ‚ã€‚æŸ¥çœ‹è¯¥æ–‡ä»¶å¹¶æ ¹æ®æ‚¨çš„é…ç½®è¿›è¡Œä¿®æ”¹ï¼ˆå®ƒ**å¯ä»¥**åŒ…å«æ³¨é‡Šï¼Œå› ä¸º VS ä¸ä¼šå¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼ï¼‰ã€‚å½“æ‚¨æœ‰å¯å·¥ä½œçš„

é…ç½®æ—¶ï¼Œè¯·å‘ŠçŸ¥æˆ‘ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä½œä¸ºæ–‡ä»¶ä¸­çš„å¦ä¸€ä¸ªé€‰é¡¹æ·»åŠ ã€‚

>GDB è¦æ±‚åœ¨ä¼ é€’ç»™å¯æ‰§è¡Œæ–‡ä»¶å’Œç¬¦å·çš„è·¯å¾„ä¸­ä½¿ç”¨ `/` åˆ†éš”ç¬¦ï¼Œè€Œä¸æ˜¯ Windows çš„åæ–œæ  `\`ï¼Œç›®å‰æ— è®ºæ˜¯ VS Code è¿˜æ˜¯ VS2017/2019 éƒ½æ— æ³•åœ¨æ‰©å±•å˜é‡æ—¶ä¸ºæˆ‘ä»¬æ‰§è¡Œæ­¤æ“ä½œï¼Œå› æ­¤éœ€è¦æ·»åŠ ç¡¬ç¼–ç çš„æ–‡ä»¶è·¯å¾„ã€‚å¯¹äº VS Codeï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆå¥½çš„å°æ‰©å±•ç¨‹åº `nf` æ¥ä¸ºæˆ‘ä»¬å¤„ç†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ç›®å‰å¯¹äº VS æ²¡æœ‰ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆã€‚

#### CMakeSettings.json

è¿™æ˜¯ç”¨äºè®¾ç½® `nf-interpreter` æ„å»ºé€‰é¡¹çš„ä¸»è¦é…ç½®æ–‡ä»¶ï¼Œä½äºæ ¹ç›®å½•ä¸­ã€‚å½“å‰å­˜å‚¨åº“ä¸­çš„å®é™…æ–‡ä»¶ä¸ `SAMPLE` ç‰ˆæœ¬ä¸åŒï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦å®¡æŸ¥çš„äº‹é¡¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›æ›´æ–°è¦†ç›–æ‚¨çš„æœ¬åœ°ä¿®æ”¹ï¼
> æ‚¨å¯èƒ½æ›´å–œæ¬¢ä»ä¸€ä¸ªæœ¬åœ°åˆ†æ”¯è¿›è¡Œå·¥ä½œï¼Œä»¥ä¿æŠ¤æ‚¨çš„æ›´æ”¹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ `develop` åˆ†æ”¯ã€‚æˆ‘ç›®å‰ä½¿ç”¨ä¸€ä¸ªåä¸º `SaveLocalSettings` çš„åˆ†æ”¯è¿›è¡Œæ„å»ºï¼Œä½¿ç”¨ä¸€ä¸ªå°è„šæœ¬è‡ªåŠ¨å°†ä¸Šæ¸¸çš„ `develop` æ›´æ”¹åˆå¹¶åˆ°å…¶ä¸­ã€‚

è¯·æ³¨æ„ï¼ŒVS2019 ä¼šè¦†ç›–æ­¤æ–‡ä»¶ï¼ä½†å¥½å¤„æ˜¯å®ƒä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªæ¼‚äº®çš„å›¾å½¢ç•Œé¢ï¼Œç”¨äºæ›´æ”¹æ„å»ºä¸­åŒ…å«çš„é€‰é¡¹å¹¶ç”Ÿæˆç³»ç»Ÿï¼Œè¿™åœ¨ VS2017 ä¸­ä¸å­˜åœ¨ã€‚è¦è®¿é—®æ­¤ç•Œé¢ï¼Œè¯·åœ¨ `Solution Explorer` ä¸­å³é”®å•å‡» `CMakeSettings.json`ï¼Œç„¶åé€‰æ‹©é€‰é¡¹ `"CMake Settings for nanoFramework"`ã€‚

### åŠ©æ‰‹æ‰¹å¤„ç†è„šæœ¬

#### RunCmd.bat

è¿™æ˜¯ä¸€ä¸ªè¾…åŠ©è„šæœ¬ï¼Œç”¨äºåœ¨å•ç‹¬çš„æ§åˆ¶å°çª—å£ä¸­è¿è¡Œå‘½ä»¤ï¼Œå¹¶åœ¨å‘½ä»¤å®Œæˆåç­‰å¾…ä¸€æ®µæ—¶é—´ç„¶åå…³é—­çª—å£ã€‚åœ¨éœ€è¦æ‰‹åŠ¨å¹²é¢„ï¼ˆä¾‹å¦‚æŒ‰ä¸‹æŒ‰é’®ï¼‰çš„æƒ…å†µä¸‹ï¼Œè¿™åœ¨ç¼–ç¨‹ ESP32 æ¿æ—¶æ˜¯å¿…éœ€çš„ã€‚`Esptool.py` ä¼šå‘é€ä¸€ç³»åˆ— `___...___...___...`ï¼Œåœ¨æ­¤æœŸé—´ï¼Œæ‚¨å¯èƒ½éœ€è¦æŒ‰ä½å¼•å¯¼æŒ‰é’®å¹¶æŒ‰ä¸‹å¤ä½æŒ‰é’®ï¼Œä½†æ˜¯ VS2019 ä¼šç¼“å†²è¾“å‡ºçª—å£ï¼Œå› æ­¤åœ¨å¤ªè¿Ÿä¹‹å‰æ‚¨çœ‹ä¸åˆ°è¿™äº›è¾“å‡ºã€‚
ç¬¬ä¸€ä¸ªå‚æ•° `n` æ˜¯ç­‰å¾…çš„ç§’æ•°ã€‚

- n = 0 - åœ¨å‘½ä»¤å®Œæˆåç­‰å¾…ç”¨æˆ·è¾“å…¥
- n > 0 - åœ¨å‘½ä»¤å®Œæˆåç­‰å¾… n ç§’
- n < 0 - ä»…åœ¨å‘½ä»¤å®Œæˆä¸”å‡ºç°é”™è¯¯æ—¶ç­‰å¾…

#### SetNFRoot.bat

æ­¤è„šæœ¬ç”¨äºå¸®åŠ©è§£å†³æ„å»º `nf-interpreter` æ—¶æ–‡ä»¶è·¯å¾„è¶…è¿‡ Windows 250 ä¸ªå­—ç¬¦é™åˆ¶çš„é—®é¢˜ã€‚å®ƒé€šè¿‡ä½¿ç”¨ Windows çš„ `SUBST` å‘½ä»¤å°†æœªä½¿ç”¨çš„é©±åŠ¨å™¨å·æ˜ å°„åˆ°æºä»£ç æ ¹ç›®å½•æ¥å®ç°ã€‚å¦‚æœå·²å­˜åœ¨æ˜ å°„ï¼Œåˆ™ä¼šé‡æ–°ä½¿ç”¨è¯¥

æ˜ å°„ã€‚å°†ç¯å¢ƒå˜é‡ `nfRoot` è®¾ç½®ä¸ºæ­¤ä½ç½®ï¼Œå¯ä»¥åœ¨ Visual Studio ä¸­è®¿é—®è¯¥ä½ç½®ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘çš„æºä»£ç æ ¹ç›®å½•ä½äº `D:\usr_chronos\Sandbox\NanoFramework\nf-interpreter\`ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```batch
D:\usr_chronos\Sandbox\NanoFramework\nf-interpreter>SetNFRoot.bat
Found free drive letter: B:
Created new subst for D:\usr_chronos\Sandbox\NanoFramework\nf-interpreter\ on B:
You can remove it with subst B: /D
Using short path B:\ for D:\usr_chronos\Sandbox\NanoFramework\nf-interpreter\
B:\
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†æºä»£ç æ ¹ç›®å½•è¡¨ç¤ºä¸º `B:\`ï¼Œå¹¶ä»é‚£é‡Œè¿›è¡Œæ„å»ºï¼Œè·¯å¾„å¤§å¤§ç¼©çŸ­ã€‚

è„šæœ¬è¾“å‡ºï¼ˆå‚è§ä¸Šé¢çš„ç¤ºä¾‹ï¼‰å‘é€åˆ° `stderr` è€Œä¸æ˜¯ `stdout`ï¼Œé™¤äº†æœ€åçš„ `B:\`ï¼Œè¿™æ„å‘³ç€å®ƒå¯ä»¥ç”¨ä½œå‘½ä»¤å˜é‡åœ¨ VS ä¸­è¿›è¡Œæ‰©å±•ï¼Œä¹Ÿå¯ä»¥ç”¨ä½œç¯å¢ƒå˜é‡æ‰©å±•ï¼Œä¾‹å¦‚ `${env.nfRoot}` æˆ– `${cmd.SetNFRoot.bat}`ã€‚

#### startocd.bat

æ­¤è„šæœ¬ç”± `GDB` è°ƒç”¨ä»¥ä½œä¸ºå•ç‹¬çš„è¿›ç¨‹å¯åŠ¨ `OpenOCD`ï¼Œæ‚¨å¯ä»¥åœ¨è„šæœ¬åº•éƒ¨æ·»åŠ å…¶ä»–æ¡ç›®ï¼Œéµå¾ªç°æœ‰çš„æ¨¡å¼ã€‚`launch.vs.json` ä¸­çš„ä¸€è¡Œå°†è¯¥æ ‡ç­¾ä¼ é€’ç»™å®ƒï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯é’ˆå¯¹ ESP32 ä½¿ç”¨ `SEGGER JLINK`ã€‚
>è¯¥è„šæœ¬å½“å‰å¯åŠ¨ `C:\\nanoFramework_Tools\\Tools\\openocd\\bin\\openocd.exe` ç”¨äº `STM32_STLINK` æ ‡ç­¾ï¼Œå¦‚æœæ‚¨æŒ‰ç…§ STM32 çš„è¯´æ˜è¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆæ‚¨å°†å®‰è£…äº†å®ƒï¼Œä½†å®é™…ä¸Šæˆ‘åœ¨ä½¿ç”¨ STM32 æ—¶å–å¾—äº†æ›´å¥½çš„ç»“æœï¼Œä½¿ç”¨çš„æ˜¯ ESP32 ç‰ˆæœ¬çš„ OpenOCDã€‚
å¦‚æœæ‚¨å·²å®‰è£…è¯¥ç‰ˆæœ¬ï¼Œè¯·å°† `:STM32_STLINK` æ ‡ç­¾åé¢çš„è¡Œæ³¨é‡Šæ‰ã€‚

### æ„å»ºä½ç½®

æˆ‘ä»¬å¯ä»¥åœ¨ä¸åŒçš„ä½ç½®è¿›è¡Œæ„å»ºï¼Œä»¥é€‚åº”æˆ‘ä»¬æ­£åœ¨å¤„ç†çš„ç›®æ ‡ç±»å‹å’Œé…ç½®ã€‚å½“å‰å¸ƒå±€æ˜¯ä½¿ç”¨ `Build` å­ç›®å½•æ¥åŒ…å«æ‰€æœ‰ä¸åŒçš„æ„å»ºç±»å‹æ–‡ä»¶å¤¹ï¼Œå› æ­¤ ESP32 çš„æ„å»ºåœ¨ `Build\ESP32` ä¸­ï¼Œæµ‹è¯•æ„å»ºåœ¨ `Build\ESP32_test` ä¸­ï¼Œç­‰ç­‰ã€‚
STM32 æ„å»ºå¾ˆå¯èƒ½éœ€è¦è¾ƒçŸ­çš„æ„å»ºè·¯å¾„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨ `CMakeSettings.json` æ–‡ä»¶çš„ STM769IDiscovery éƒ¨åˆ†ä½¿ç”¨ `"${env.nfRoot}Build/${name}"`ã€‚ç„¶åï¼Œæ„å»ºå°†åœ¨ `"B:\\Build\\STM769IDiscovery"` ä¸­è¿›è¡Œã€‚

### è°ƒè¯•

ç¨‹åºæ„å»ºå¹¶åŠ è½½åˆ° Flash ä¸­åï¼Œæ‚¨å¯ä»¥å¯åŠ¨è°ƒè¯•å™¨ã€‚æ‚¨éœ€è¦ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹©å¯åŠ¨é…ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

![VS2019 å·¥å…·æ ](../../images/getting-started/VS2019Toolbars.png)

>è¯·æ³¨æ„ï¼Œå¯åŠ¨é…ç½®ï¼ˆåœ¨æ­¤å¤„ä¸º `ESP32 nanoCLR - Segger

 JLink`ï¼‰å¯èƒ½ä¸ä¼šç«‹å³æ˜¾ç¤ºåœ¨ä¸‹æ‹‰èœå•ä¸­ä¾›é€‰æ‹©ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´æ‰èƒ½å¯ç”¨ã€‚æˆ‘ä»¬å‡è®¾ VS2019 åœ¨åå°æ‰§è¡ŒæŸäº›æ“ä½œï¼Œå¦‚æœæœ‰äººäº†è§£åŸå› æˆ–è€…çŸ¥é“åŠ å¿«æ­¤è¿‡ç¨‹çš„æ–¹æ³•ï¼Œè¯·å‘Šè¯‰æˆ‘ä»¬ï¼

ç„¶åï¼Œæ‚¨å¯ä»¥ä»é¡¶éƒ¨çš„ DEBUG èœå•å¼€å§‹è°ƒè¯•ã€‚

OpenOCD åº”è¯¥ä¼šåœ¨è‡ªå·±çš„æ§åˆ¶å°çª—å£ä¸­æ‰“å¼€ï¼Œè¿æ¥åˆ°ç›®æ ‡è®¾å¤‡ï¼Œå¹¶æ˜¾ç¤ºç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š

![OpenOCD æ§åˆ¶å°](../../images/getting-started/OpenOCDConsole.png)

åœ¨ VS2019 IDE è¾“å‡ºçª—å£ä¸­ï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š

```text
=thread-group-added,id="i1"
GNU gdb (crosstool-NG crosstool-ng-1.22.0-80-g6c4433a5) 7.10
Copyright (C) 2015 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "--host=i686-host_pc-mingw32 --target=xtensa-esp32-elf".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word".
Warning: Debuggee TargetArchitecture not detected, assuming x86_64.
=cmd-param-changed,param="pagination",value="off"
@"Detected debug stubs @ 3ffcbaa0 on core0 of target 'esp32'\n"
@"Target halted. PRO_CPU: PC=0x400D1F4C (active)    APP_CPU: PC=0x4000C276 \n"
[New Thread 1073557668]
[New Thread 1073555768]
[New Thread 1073561472]
[New Thread 1073560324]
[New Thread 1073548060]
[New Thread 1073544580]
[New Thread 1073546588]
[New Thread 1073549192]
[Switching to Thread 1073553736]

Temporary breakpoint 1, app_main () at ../../targets/FreeRTOS_ESP32/ESP32_WROOM_32/nanoCLR/app_main.c:50
50 {
=breakpoint-deleted,id="1"
```

å¤„ç†å™¨ç°åœ¨åœåœ¨ç”±æˆ‘ä»¬çš„ `launch.vs.json` å¯åŠ¨é¡ºåºæ’å…¥çš„ä¸´æ—¶æ–­ç‚¹å¤„ï¼Œå®ƒåœ¨æºä»£ç çª—å£ä¸­æ˜¾ç¤ºä¸ºå…¥å£ç‚¹å¤„çš„å¼‚å¸¸ã€‚

![VS2019 æ–­ç‚¹](../../images/getting-started/VS2019Breakpoint.png)

ç°åœ¨ï¼Œæ‚¨å¯ä»¥é€æ­¥æ‰§è¡Œä»£ç ï¼Œè§‚å¯Ÿå˜é‡ï¼Œè®¾ç½®æ–­ç‚¹ç­‰ç­‰ã€‚

### æ€»ç»“

æ­¤æ–‡æ¡£ä»åœ¨ä¸æ–­æ›´æ–°ä¸­ï¼Œä¸æ­¤ç±»é¡¹ç›®ä¸€æ ·ï¼ŒVS å¯¹å…¶çš„æ”¯æŒä¹Ÿåœ¨ä¸æ–­æ”¹è¿›ä¸­ã€‚

æ¬¢è¿æ‚¨çš„åé¦ˆå’Œè´¡çŒ®ï¼

[åé¦ˆ](#

feedback)

---

## åœ¨ Visual Studio 2017 Community Edition ä¸­å¼€å‘ nanoFramework å›ºä»¶

[(è¯·å‚é˜…ä¸Šé¢å…³äº VS2019 çš„è¯´æ˜)](#developing-firmware-for-the-nanoframework-using-visual-studio-2019-community-edition)

### VS2019 çš„è¯´æ˜æ›´ä¸ºæ›´æ–°ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¯ç”¨äº VS2017

### ğŸš§ é‡è¦æç¤ºï¼šæ­£åœ¨æ„å»º Visual Studio çš„å›ºä»¶æ„å»ºè¿‡ç¨‹ã€‚ğŸš§

ä¸ºäº†ä½¿å…¶æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦åšå‡ºä¸€äº›å¦¥åã€‚
æˆ‘å†³å®šå°†ä»£ç æ”¾åœ¨é¡¶å±‚ï¼Œä»¥å‡å°‘æ–‡ä»¶è·¯å¾„çš„é•¿åº¦ï¼Œè¿™å¯¼è‡´äº†æ½œåœ¨çš„å‘½ä»¤è¡Œæº¢å‡ºè­¦å‘Šã€‚
>ä½¿ç”¨ç¡¬ç¼–ç çš„è·¯å¾„æ¥ç¡®ä¿å®ƒä¸å½“å‰çš„ CMake ç¼–ç å’Œ Microsoft çš„ CMake ç”¨æ³•æ­£å¸¸å·¥ä½œ
>ä½¿ç”¨ `CMakeSettings.json` æ–‡ä»¶ä¸­çš„åˆ†éš”ç¬¦çš„é—®é¢˜ã€‚

### é¡¹ç›®çš„ç›®å½•ç»“æ„

ä¸ºäº†æ”¯æŒåœ¨ Visual Studio ä¸­å¼€å‘ï¼Œå·²ç»åˆ›å»ºäº†ä¸¤ä¸ªé¡¶çº§ç›®å½•ã€‚

- `c:\\nanoFramework\\nf-interpreter`
- `c:\\nanoFramework_Tools`

#### c:\\nanoFramework\\nf-interpreter

- å°† nf-interpreter å­˜å‚¨åº“å…‹éš†åˆ°æ­¤ç›®å½•ä¸­ã€‚

##### c:\\nanoFramework\\nf-interpreter\Build

- æ­¤ç›®å½•åŒ…å«æ„å»ºè¾“å‡ºï¼Œå…¶ä¸­çš„æ–‡ä»¶æ˜¯æš‚æ—¶çš„ã€‚å½“åˆ é™¤ CMake ç¼“å­˜æ—¶ï¼Œæ­¤ç›®å½•ä¸­çš„æ–‡ä»¶ä¹Ÿä¼šè¢«åˆ é™¤ã€‚
è¿™äº›æ–‡ä»¶ä»…åœ¨é€‰æ‹© "æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶" æ—¶å¯è§ã€‚è¿™äº›æ–‡ä»¶ä¸æ˜¯ GIT å­˜å‚¨åº“çš„ä¸€éƒ¨åˆ†ã€‚
åœ¨æˆåŠŸæ„å»ºç»“æŸæ—¶ï¼Œæ„å»ºè¾“å‡ºä¼šè¢«å¤åˆ¶åˆ° *\Build* ç›®å½•ä¸­ã€‚

> - æ³¨æ„ï¼šå¦‚æœ Visual Studio è¡¨ç°å‡ºä¸è‰¯è¡Œä¸ºï¼Œæœ‰æ—¶éœ€è¦åˆ é™¤è¿™äº›æ–‡ä»¶å¤¹ä¸­çš„å†…å®¹ã€‚
ä½¿ç”¨ Visual Studio ä¸ CMake ä¼šå¯¼è‡´å‡ºç°çœ‹ä¼¼ä¸ä¸€è‡´çš„æƒ…å†µã€‚
æœ‰æ—¶ï¼ŒCMake æœåŠ¡å™¨ä¼šå…³é—­ï¼Œé‡å¯ Visual Studio é€šå¸¸å¯ä»¥è§£å†³é—®é¢˜ã€‚
> - æ³¨æ„ï¼šåœ¨æ¸…é™¤ CMake ç¼“å­˜åï¼Œæœ‰æ—¶æ„å»º/chibios_source ç›®å½•ä¼šå˜ä¸ºç©ºæˆ–åªåŒ…å« .git æ–‡ä»¶ï¼Œè¿™æ˜¯ç”±äºæŸäº›å†²çªå¼•èµ·çš„ã€‚
>å½“å‰çš„ CMakeLists.txt æ–‡ä»¶ä¼šæŸ¥æ‰¾è¯¥ç›®å½•å¹¶ä¸é‡æ–°å¤åˆ¶ä»£ç ã€‚
>éœ€è¦æ‰‹åŠ¨ä»æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­åˆ é™¤ç›®å½•å¹¶ç”Ÿæˆç¼“å­˜ï¼Œä»¥ä½¿å¤åˆ¶è¿è¡Œã€‚

#### c:\\nanoFramework_Tools

æ‰‹åŠ¨åˆ›å»ºæ­¤ç›®å½•ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹æ–‡ä»¶å¤¹ã€‚

##### c:\\nanoFramework_Tools\\ChibiOS

ä» <https://svn.osdn.net/svnroot/chibios/branches/stable_21.11.x> å…‹éš†çš„ ChibiOS å­˜å‚¨åº“çš„å‰¯æœ¬ã€‚

##### c:\\nanoFramework_Tools\\Tools\\openocd

OpenOCD å®‰è£…çš„å‰¯æœ¬ <https://github.com/xpack-dev-tools/openocd-xpack/releases>

##### c:\\nanoFramework_Tools\\Tools

åœ¨æ­¤å¤„æ”¾ç½® hex2dfu.exe å·¥å…·çš„å‰¯æœ¬

### ä¸»è¦é…ç½®æ–‡ä»¶

#### ä¸»è¦çš„ CMakeSettings.json

> Visual Studio ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ã€‚è¿™æ˜¯ C

Make å¼€å‘çš„æ ‡å‡†é…ç½®æ–‡ä»¶ã€‚
> æ­¤æ–‡ä»¶å¯ä»¥åŒ…å«å¤šä¸ªé…ç½®ã€‚é™¤äº†è®¾ç½®ç¼–è¯‘å™¨å·¥å…·é“¾å¤–ï¼Œè¿˜å®šä¹‰äº†é€‰æ‹©è¦æ„å»ºçš„ç›®æ ‡ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å…¶ä»–å˜é‡ã€‚
> **æ³¨æ„**ï¼šå·¥ä½œæ­£åœ¨è¿›è¡Œä¸­

#### CMakeLists.txt

> nf-intepreter çš„æ ‡å‡† CMakeLists.txt æ–‡ä»¶

#### ä¸»è¦çš„ launch.vs.json

> ä½¿ç”¨é…ç½®è®¾ç½®è°ƒè¯•ç¯å¢ƒï¼Œé€šè¿‡é…ç½®ä½¿ç”¨ gdbserver è¿›è¡Œè°ƒè¯•ã€‚
> ç¤ºä¾‹ä¸­å¼•ç”¨äº† openocd åº”ç”¨ç¨‹åºã€‚

#### è®¾ç½®å’Œå®‰è£…

| è½¯ä»¶ç»„ä»¶ | è¯´æ˜ | é“¾æ¥ |
|:---|---|---|
| Visual Studio 2017 Community Edition | ä¸ C++ ä¸€èµ·è¿›è¡Œ Linux å¼€å‘ ||
|option|Visual C++ ç”¨äº CMake å’Œ Linux çš„å·¥å…·ç»„ä»¶||
|option|åµŒå…¥å¼å’Œç‰©è”ç½‘å¼€å‘|GCC ç‰ˆæœ¬ 6.3.1. December/2018|
|GCC å·¥å…·é“¾ - Version 7-2018-q2-update|GNU Arm åµŒå…¥å¼å·¥å…·é“¾|<https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads>|

#### GCC å·¥å…·é“¾æ³¨é‡Š

> ç”± Visual Studio å®‰è£…çš„ç‰ˆæœ¬ 6.3.1 åœ¨ fallthrough æ–¹é¢å­˜åœ¨é—®é¢˜ï¼Œç‰ˆæœ¬ 8 åœ¨ç»“æ„æ–¹é¢å­˜åœ¨é—®é¢˜ï¼ˆå·²ç»æå‡ºé—®é¢˜ä»¥ä¿®å¤ï¼‰ã€‚

å·²ä¸‹è½½ã€å®‰è£…å’Œæµ‹è¯•äº†ä»¥ä¸‹ GCC ç‰ˆæœ¬ã€‚
> GNU Arm åµŒå…¥å¼å·¥å…·é“¾ - Version 7-2018-q2-update
    <https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads>#

åœ¨ CMakeSettings.json ä¸­ï¼Œä»¥ä¸‹å˜é‡ç¡®å®šæ„å»ºå·¥å…·ã€‚

```json
{
        "name": "TOOLCHAIN_PREFIX",
        "value": "C:/Program Files (x86)/GNU Tools Arm Embedded/7 2018-q2-update"
        // "value": "${env.GCCPATH}"   // Visual Studio å®‰è£…çš„æ ‡å‡† GCC 6.3.1
},
```

åœ¨ CMakeSettings.json ä¸­ï¼ŒVISUAL_STUDIO å˜é‡è®¾ç½®äº†ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ¥è§£å†³æ„å»ºç³»ç»Ÿä¸­çš„é—®é¢˜ã€‚
å¦‚æœä½¿ç”¨ `add_custom_command` ä¸ `POST_BUILD`ï¼Œåˆ™æ„å»ºç¼–è¯‘ä½†ä¸é“¾æ¥ï¼Œå› ä¸ºå‡ºç°äº†â€œcmd.exeâ€ä¸è¢«è¯†åˆ«çš„é—®é¢˜ã€‚

```json
{
        "name": "VISUAL_STUDIO",
        "value": "TRUE"
},
```

ä¸ºäº†é¿å…æ­¤é—®é¢˜ï¼Œä¸ä¼šè¿è¡Œè‡ªå®šä¹‰å‘½ä»¤ä»¥å¤åˆ¶æ„å»ºè¾“å‡ºã€‚
æ‚¨å¯ä»¥åœ¨å‘½ä»¤æç¤ºç¬¦ä¸­æ‰‹åŠ¨æ‰§è¡Œ `CopyBuildOutput.cmd` æ¥è¿è¡Œç­‰æ•ˆçš„å‘½ä»¤ã€‚

#### è°ƒè¯•è§£å†³æ–¹æ¡ˆ

launch.vs.json æ–‡ä»¶åŒ…å«ä¸€ä¸ªç¤ºä¾‹é…ç½®ï¼Œç”¨äºè®¾ç½®è°ƒè¯• STM32769IDiscovery æ¿çš„ç¯å¢ƒã€‚
å¯ä»¥æ·»åŠ å…¶ä»–é…ç½®ï¼Œå°½ç®¡é€‰é¡¹çš„å®ç°ä¼¼ä¹ä¸ VSCODE ç‰ˆæœ¬ä¸ä¸€è‡´ï¼ŒæŸäº›é€‰é¡¹ä¼¼ä¹æ— æ³•æ­£å¸¸å·¥ä½œã€‚
æ­¤å¤–ï¼Œæ•´ä¸ªç³»ç»Ÿæœ‰ç‚¹ä¸ç¨³å®šã€‚openocd ç¨‹åºä½œä¸º Visual Studio çš„å­è¿›ç¨‹è¿è¡Œï¼Œå¦‚æœé‡åˆ°é—®é¢˜ï¼Œåˆ™ç³»ç»Ÿä¼šå´©æºƒï¼Œæ‚¨å¿…é¡»æ‰“å¼€ä»»åŠ¡ç®¡ç†

å™¨æ¥ç»“æŸä½œä¸º Visual Studio è¿›ç¨‹çš„ openocd.exe ä»»åŠ¡ã€‚

#### è¯Šæ–­è°ƒè¯•å’Œ launch.vs.json çš„é—®é¢˜

æ‚¨å¯ä»¥é€šè¿‡åœ¨ Visual Studio ä¸­é€‰æ‹©å‘½ä»¤çª—å£ï¼ˆCtrl+Alt+Aï¼‰å¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰“å¼€è°ƒè¯•æ—¥å¿—è®°å½•æ¥æ›´å¥½åœ°äº†è§£å¯èƒ½å‘ç”Ÿçš„é—®é¢˜ã€‚

`debug.midebuglog /On:c:\Temp\debug.log`

è¿è¡Œè°ƒè¯•ä¼šè¯ä»¥æ”¶é›†æ•°æ®ï¼Œå¹¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å…³é—­ã€‚

`debug.midebuglog /Off`

è¿™å°†ä¸ºæ‚¨æä¾›æ“ä½œå’Œé€šä¿¡çš„æ—¥å¿—è®°å½•ã€‚ç¥æ‚¨å¥½è¿ï¼

> ç¤ºä¾‹ä»£ç æ®µæ˜¾ç¤ºäº†ä¸ "Monitor reset halt" ç›¸å…³çš„é”™è¯¯ï¼ˆå°šä¸ç¡®å®šåŸå› ï¼‰

```text
        8: (1976730) ->^done
        8: (1976730) <-1005-interpreter-exec console  "monitor reset halt"
        8: (1976730) ->(gdb)`
        8: (1976741) ->&"\"monitor\" command not supported by this target.\n"
        8: (1976742) ->1005^error,msg="\"monitor\" command not supported by this target."
        8: (1976742) ->(gdb)
        8: (1976742) 1005: elapsed time 11
        8: (1976742) <-1006-interpreter-exec console "monitor reset init"
        8: (1976742) ->&"\n"
        8: (1976742) ->^done
        8: (1976742) ->(gdb)
```

---

#### åé¦ˆ

å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨æ­¤æ–‡æ¡£ï¼Œè¯·æä¾›åé¦ˆï¼Œæˆ‘ä»¬éå¸¸æ„Ÿè°¢ã€‚è¯·åŠ å…¥æˆ‘ä»¬çš„ [Discord ç¤¾åŒº](https://discord.gg/gCyBu8T) å¹¶å¼€å§‹è®¨è®ºã€‚